<!doctype html>
<html lang="en">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>fixtime</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fontsource/source-sans-3@5.0.12/index.css"
        integrity="sha256-tXJfXfp6Ewt1ilPzLDtQnJV4hclT9XuaZUKyUvmyr+Q=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/overlayscrollbars@2.10.1/styles/overlayscrollbars.min.css"
        integrity="sha256-tZHrRjVqNSRyWg2wbppGnT833E/Ys0DHWGwT04GiqQg=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
        integrity="sha256-9kPW/n5nn53j4WMRYAxe9c1rCY96Oogo/MKSVdKzPmI=" crossorigin="anonymous" />
    <link rel="stylesheet" href="css/estilos.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/apexcharts@3.37.1/dist/apexcharts.css"
        integrity="sha256-4MX+61mt9NVvvuPjUWdUdyfZfxSB1/Rf9WtqRHgG5S0=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jsvectormap@1.5.3/dist/css/jsvectormap.min.css"
        integrity="sha256-+uGLJmmTKOqBr+2E6KDYs/NRsHxSkONXFHUL0fy2O/4=" crossorigin="anonymous" />
</head>

<body class="layout-fixed sidebar-expand-lg bg-body-tertiary">
    <div class="app-wrapper">
        <nav class="app-header navbar navbar-expand bg-body">
            <div class="container-fluid">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item dropdown"><a class="nav-link" data-bs-toggle="dropdown" href="#"><i
                                class="bi bi-bell-fill"></i><span
                                class="navbar-badge badge text-bg-warning">15</span></a>
                        <div class="dropdown-menu dropdown-menu-lg dropdown-menu-end"><span
                                class="dropdown-item dropdown-header">15 Notificaciones</span>
                            <div class="dropdown-divider"></div>
                            <a href="#" class="dropdown-item"><i class="bi bi-envelope me-2"></i> 4 new messages <span
                                    class="float-end text-secondary fs-7">3 mins</span></a>
                            <div class="dropdown-divider"></div>
                            <a href="#" class="dropdown-item"><i class="bi bi-people-fill me-2"></i> 8 friend requests
                                <span class="float-end text-secondary fs-7">12 hours</span></a>
                            <div class="dropdown-divider"></div>
                            <a href="#" class="dropdown-item"><i class="bi bi-file-earmark-fill me-2"></i> 3 new reports
                                <span class="float-end text-secondary fs-7">2 days</span></a>
                            <div class="dropdown-divider"></div>
                            <a href="#" class="dropdown-item dropdown-footer"> See All Notifications </a>
                        </div>
                    </li>
                    <li class="nav-item dropdown user-menu"><a href="#" class="nav-link dropdown-toggle"
                            data-bs-toggle="dropdown"><img src="img/user2-160x160.jpg"
                                class="user-image rounded-circle shadow" alt="User Image" /><span
                                class="d-none d-md-inline">Fulanito Detal</span></a>
                        <ul class="dropdown-menu dropdown-menu-lg dropdown-menu-end">
                            <li class="user-header text-bg-primary"><img src="img/user2-160x160.jpg"
                                    class="rounded-circle shadow" alt="User Image" />
                                <p> Fulanito Detal<small>Usuario</small></p>
                            </li>
                            <li class="user-footer"><a href="index.html" class="btn btn-default btn-flat float-end">Salir</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </nav>
        <aside class="app-sidebar bg-body-secondary shadow" data-bs-theme="dark">
            <div class="sidebar-brand"><a href="./index.html" class="brand-link"><img src="img/fixtimeLogo.svg"
                        alt="AdminLTE Logo" class="brand-image" /><span class="brand-text fw-light"></span></a></div>
            <div class="sidebar-wrapper">
                <nav class="mt-2" id="nav">
                </nav>
            </div>
        </aside>
        <main class="app-main">
            <div class="app-content-header">
                <div class="container">
                    <div class="row">
                        <div class="col-sm-6">
                            <h3 class="mb-0">Mis citas</h3>
                        </div>
                    </div>
                </div>
            </div>
            <div class="app-content">
                <div class="container">
                    <div class="row">
                        <div class="col-md-6 col-sm-6 col-12">

                            <div class="container">
                                <button id="btnCargarCitas" class="btn btn-primary mb-3">Cargar Mis Citas</button>
                                <div id="citas-container" class="row">
                                    <!-- Aquí se insertarán dinámicamente las citas -->
                                </div>
                            </div>
                            <div class="card-body">
                                <nav aria-label="...">
                                    <ul class="pagination">
                                        <li class="page-item disabled"><a class="page-link">Anterior</a></li>
                                        <li class="page-item active" aria-current="page"><a class="page-link"
                                                href="#">1</a>
                                        </li>
                                        <li class="page-item"><a class="page-link" href="#">2</a></li>
                                        <li class="page-item"><a class="page-link" href="#">3</a></li>
                                        <li class="page-item"><a class="page-link" href="#">Siguiente</a></li>
                                    </ul>
                                </nav>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
        <footer class="app-footer">
            <div class="float-end d-none d-sm-inline">Fixtime</div>
        </footer>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/overlayscrollbars@2.10.1/browser/overlayscrollbars.browser.es6.min.js"
        integrity="sha256-dghWARbRe2eLlIJ56wNB+b760ywulqK3DzZYEpsg2fQ=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
        integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"
        integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy"
        crossorigin="anonymous"></script>
    <script src="js/adminlte.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="js/tokenservice.js"></script>

    <script>
       
        function mostrarCitas(citas) {
            const contenedor = document.getElementById('citas-container');
            contenedor.innerHTML = '';

            if (!citas || citas.length === 0) {
                contenedor.innerHTML = '<div class="col-12"><p class="text-center">No tienes citas agendadas</p></div>';
                return;
            }

            citas.forEach(cita => {
                const fecha = new Date(cita.fechaHora);
                const fechaTexto = fecha.toLocaleDateString('es-ES', {
                    weekday: 'long',
                    day: 'numeric',
                    month: 'long',
                    year: 'numeric'
                });
                const horaTexto = fecha.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });

                const card = document.createElement('div');
                card.className = 'col-md-6 col-sm-6';

                card.innerHTML = `
                <div class="info-box">
                    <div class="info-box-content">
                        <div class="info-box-content-inner">
                            <span class="info-box-icon">
                                <img src="img/calendarIcon.svg" width="100%" alt="">
                            </span>
                            <div class="col-md-6">
                                <strong>${fechaTexto}</strong>
                                <p><i class="bi bi-clock-fill"></i> ${horaTexto}</p>
                            </div>
                            <div class="col-md-6 inlineButtonsCard">
                                <button class="actionCard actionInfo" onclick="cambiarEstadoCita('${cita.citaId}', '${cita.estado}')">Cambiar estado</button>
                                <p>${cita.estado}</p>
                            </div>
                        </div>
                        <hr>
                        <div class="info-box-content-inner">
                            <div class="col-md-6">
                                <strong>${cita.taller?.nombre || 'N/A'}</strong>
                                <p>${cita.taller?.ubicacion || ''}</p>
                            </div>
                            <div class="col-md-6 servCardInner">
                                <aside>
                                    <span class="info-box-icon">
                                        <img src="img/servicio.svg" width="100%" alt="">
                                    </span>
                                </aside>
                                <aside>
                                    <strong>${cita.servicio?.nombre || 'Servicio'}</strong>
                                    <p>${cita.servicio?.descripcion || ''}</p>
                                    <strong>$${cita.servicio?.precio || 0}</strong>
                                </aside>
                            </div>
                        </div>
                    </div>
                </div>
            `;

                contenedor.appendChild(card);
            });
        }

        async function obtenerCitasPorRol() {
            try {
                const token = localStorage.getItem("jwt");
                const decode = parseJwt(token);
                const user_id = decode.UsuarioID;
                const rol = decode.role;
                console.log("Token decodificado:", decode);
                console.log(rol);
                console.log("User ID:", user_id);
                console.log("Rol:", rol);

                const url="https://localhost:7190/api/Citas/ConsultarCitasPorRcepecionistaID/" + user_id;

                console.log("URL generada:", url);

                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    }
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || "Error al obtener las citas");
                }

                return await response.json();
            } catch (error) {
                console.error("Error en obtenerCitasPorRol:", error.message);
                throw new Error(error.message);
            }
        }


       function cambiarEstadoCita(id, estadoActual) {
            const estados = ['No asistió', 'Cancelada', 'Finalizada', 'En Proceso', 'Pendiente'];
            console.log('ID de cita recibido:', id);
            console.log("Estado de la cita "+estadoActual)

            let optionsHTML = estados.map(estado => `
                <option value="${estado}" ${estado === estadoActual ? 'selected' : ''}>${estado}</option>
            `).join('');

            Swal.fire({
                title: '¿Deseas cambiar el estado de la cita?',
                html: `
                    <select id="nuevoEstado" class="swal2-select" style="padding: 10px;">
                        ${optionsHTML}
                    </select>
                `,
                showCancelButton: true,
                confirmButtonText: 'Guardar',
                cancelButtonText: 'Cancelar',
                preConfirm: () => {
                    const nuevoEstado = document.getElementById('nuevoEstado').value;
                    if (!nuevoEstado) {
                        Swal.showValidationMessage('Debes seleccionar un estado');
                    }
                    return nuevoEstado;
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    const nuevoEstado = result.value;

                    const estadoDTO={
                        Estado:nuevoEstado
                    };

                    fetch(`https://localhost:7190/api/Citas/ActualizarEstadoCita/${id}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'text/plain',
                            'Authorization': 'Bearer ' + localStorage.getItem("jwt")
                        },
                        body: JSON.stringify(estadoDTO)
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Error al actualizar el estado');
                        }
                        return response.text(); 
                    })
                    .then(data => {
                        Swal.fire('¡Estado actualizado!', `La cita ha sido marcada como "${nuevoEstado}".`, 'success')
                        .then(() => {
                            location.reload(); // Recargar la página o actualizar datos si es necesario
                        });
                    })
                    .catch(error => {
                        Swal.fire('Error', 'No se pudo actualizar el estado de la cita.', 'error');
                        console.error('Error al actualizar el estado:', error);
                    });
                }
            });
        }
        
        // Evento para el botón
        document.getElementById("btnCargarCitas").addEventListener("click", async () => {
            try {
                const citas = await obtenerCitasPorRol();
                console.log('ID de cita:', cita.id);
                mostrarCitas(citas);
            } catch (err) {
                console.error('Error al cargar citas:', err.message);
            }
        });

        // Cargar citas automáticamente al entrar a la página
        document.addEventListener('DOMContentLoaded', async () => {
            const loadingSwal = Swal.fire({
                title: 'Cargando citas',
                html: 'Por favor espera...',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            try {
                const citas = await obtenerCitasPorRol();
                mostrarCitas(citas);
            } catch (err) {
                console.error("Error al cargar citas:", err.message);
            } finally {
                Swal.close();
            }
        });
    </script>

</body>

</html>