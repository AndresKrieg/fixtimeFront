<!doctype html>
<html lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Agendar</title>
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.9/index.global.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fontsource/source-sans-3@5.0.12/index.css" integrity="sha256-tXJfXfp6Ewt1ilPzLDtQnJV4hclT9XuaZUKyUvmyr+Q=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/overlayscrollbars@2.10.1/styles/overlayscrollbars.min.css" integrity="sha256-tZHrRjVqNSRyWg2wbppGnT833E/Ys0DHWGwT04GiqQg=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" integrity="sha256-9kPW/n5nn53j4WMRYAxe9c1rCY96Oogo/MKSVdKzPmI=" crossorigin="anonymous" />
    <link rel="stylesheet" href="css/estilos.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/apexcharts@3.37.1/dist/apexcharts.css" integrity="sha256-4MX+61mt9NVvvuPjUWdUdyfZfxSB1/Rf9WtqRHgG5S0=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jsvectormap@1.5.3/dist/css/jsvectormap.min.css" integrity="sha256-+uGLJmmTKOqBr+2E6KDYs/NRsHxSkONXFHUL0fy2O/4=" crossorigin="anonymous" />
    <link rel="stylesheet" href="css/calendar.css">
  </head>
  <body class="layout-fixed sidebar-expand-lg bg-body-tertiary">
    <div class="app-wrapper">
      <nav class="app-header navbar navbar-expand bg-body">
        <div class="container-fluid">
          <ul class="navbar-nav ms-auto">
               
            <li class="nav-item dropdown user-menu">
                        <a href="#" class="nav-link dropdown-toggle"
                            data-bs-toggle="dropdown">
                            <img src="img/user2-160x160.jpg" class="user-image rounded-circle shadow" alt="User Image" />
                            <span class="d-none d-md-inline nombre-usuario">Fulanito Detal</span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-lg dropdown-menu-end">
                            <li class="user-header text-bg-primary">
                                <img src="img/user2-160x160.jpg" class="rounded-circle shadow" alt="User Image" />
                                <p class="nombre-usuario"> Fulanito Detal</p><small class="rol-usuario">Usuario</small>
                            </li>

                            <li class="user-footer"><a href="index.html"
                                    class="btn btn-default btn-flat float-end">Salir</a></li>
                        </ul>
                    </li>
          </ul>
        </div>
      </nav>
      <aside class="app-sidebar bg-body-secondary shadow" data-bs-theme="dark">
        <div class="sidebar-brand"><a href="./index.html" class="brand-link"><img src="img/fixtimeLogo.svg" alt="AdminLTE Logo" class="brand-image" /><span class="brand-text fw-light"></span></a></div>
        <div class="sidebar-wrapper">
          <nav class="mt-2" id="nav">
      
          </nav>
        </div>
      </aside>
      <main class="app-main">
        <div class="app-content-header">
          <div class="container">
            <div class="row">
              <div class="col-sm-6">
                <h3 class="mb-0">Seleciona una fecha</h3>
              </div>
            </div>
          </div>
        </div>
        <div class="app-content">
          <div class="container">
            <div class="progress mb-2" role="progressbar" aria-label="succes striped example" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100">
              <div class="progress-bar progress-bar-striped progress-bar-animated bg-success" style="width: 66%; border-radius: 0.375rem"></div>
            </div>
            <div class="space"></div>
            <section class="agendamientoCalendar">
              <div class="titleMap">
                <p>Selecciona en el calendario la fecha que mas se adapte a tus necesidades, recuerda que puedes modificar tu cita cuando lo requieras.</p>
              </div>
              <article class="mapSelect row">
                <aside class="col-md-8">
                  <div id="calendar"></div>
                </aside>
                <aside class="col-md-4">
                  <form class="needs-validation" novalidate id="form-cita">
                    <div>
                      <h3 id="nombre-taller">Cargando datos del taller...</h3>
                      <p><i class="bi bi-geo-alt-fill"></i><span id="direccion-taller">Cargando dirección...</span></p><a href="agendar.html">Cambiar</a>
                    </div>
                    <div>
                      <aside><span><img src="img/calendarIcon.svg" width="100%" alt=""></span>
                        <p id="fecha-seleccionada">Selecciona una fecha</p>
                      </aside>
                      <aside><select class="form-select" id="hora-cita" required>
                          <option selected disabled value="">Selecciona una hora</option>
                          <option value="08:00">08:00 AM</option>
                          <option value="09:00">09:00 AM</option>
                          <option value="10:00">10:00 AM</option>
                          <option value="11:00">11:00 AM</option>
                          <option value="14:00">02:00 PM</option>
                          <option value="15:00">03:00 PM</option>
                          <option value="16:00">04:00 PM</option>
                        </select><span class="invalid-feedback">Seleccione una hora</span></aside>
                    </div>
                    <div>
                      <h3>¿Deseas agregar un servicio extra?</h3><select class="form-select" id="servicio-extra" required>
                        <option selected disabled value="">Selecciona una servicio</option>
                        <option value="1"><i class="bi bi-gear-fill"></i>Servicio tipo 1 {precio}</option>
                      </select><span class="invalid-feedback"> Selecciona el tipo de servicio</span>
                    </div>
                    <div class="card-footer"><button id="btn-registrar" class="btn btn-primary" type="submit">Registrarme</button></div>
                  </form>
                </aside>
              </article>
            </section>
          </div>
          </section>
        </div>
      </main>
      <footer class="app-footer">
        <div class="float-end d-none d-sm-inline">fixtime</div>
      </footer>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.9/index.global.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/overlayscrollbars@2.10.1/browser/overlayscrollbars.browser.es6.min.js" integrity="sha256-dghWARbRe2eLlIJ56wNB+b760ywulqK3DzZYEpsg2fQ=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js" integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy" crossorigin="anonymous"></script>
    <script src="js/adminlte.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="js/tokenservice.js"></script>
    <script>
      let fechaSeleccionada = null;
      let horaSeleccionada = null;


      const token = localStorage.getItem("jwt")
      const decode=parseJwt(token)
      const user_id=decode.UsuarioID
      
      // Cargar datos del taller desde sessionStorage
      document.addEventListener('DOMContentLoaded', async function() {
        try {
          // Obtener datos del sessionStorage
          const citaData = JSON.parse(sessionStorage.getItem('citaData')) || {};
          console.log(citaData);
          const tallerId = citaData.tallerId || "1"; // Valor por defecto
          const administradorID=citaData.AdministradorID;
          console.log(administradorID);
          
          // Consultar información del taller
          await cargarDatosTaller(tallerId);
          
          // Inicializar el calendario
          inicializarCalendario();
          
          // Configurar el formulario
          configurarFormulario();
        } catch(error) {
          console.error("Error al inicializar la página:", error);
          mostrarError("No se pudieron cargar los datos correctamente");
        }
      });
      
      // Función para cargar datos del taller
      async function cargarDatosTaller(tallerId) {
        try {
          
          console.log("User ID:", user_id);
          const citaData = JSON.parse(sessionStorage.getItem('citaData')) || {};

          const response = await fetch(`https://localhost:7190/api/Taller/ObtenerTallerPorID/${citaData.tallerId}`, {
            method: "GET",
            headers: {
              'Content-Type': 'application/json',
              'Authorization': 'Bearer ' + token
            }
          });

          const data = await response.json();

          const taller = {
            nombre: data.nombre,
            direccion: data.ubicacion
          };
          // Actualizar interfaz con los datos del taller
          document.getElementById('nombre-taller').textContent = taller.nombre;
          document.getElementById('direccion-taller').textContent = taller.direccion;
        } catch(error) {
          console.error("Error al cargar datos del taller:", error);
          mostrarError("No se pudo cargar la información del taller");
        }
      }
      
      // Inicializar calendario
      function inicializarCalendario() {
        const calendarEl = document.getElementById('calendar');
        const calendar = new FullCalendar.Calendar(calendarEl, {
          initialView: 'dayGridMonth',
          locale: 'es',
          headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,timeGridDay'
          },
          selectable: true,
          dateClick: function(info) {
            // Quitar la clase de cualquier fecha previamente seleccionada
            document.querySelectorAll('.fc-daygrid-day.selected-date')
                    .forEach(el => el.classList.remove('selected-date'));

            // Agregar la clase a la celda seleccionada
            info.dayEl.classList.add('selected-date');

            // Guardar la fecha seleccionada
            fechaSeleccionada = info.dateStr;
            const fecha = new Date(info.dateStr);

            // Formatear fecha al español
            const opciones = { weekday: 'long', day: 'numeric', month: 'long' };
            const fechaFormateada = fecha.toLocaleDateString('es-ES', opciones);

            // Capitalizar primera letra del día y mes
            const fechaPartes = fechaFormateada.split(' ');
            const diaSemana = fechaPartes[0].charAt(0).toUpperCase() + fechaPartes[0].slice(1);
            const diaMes = fechaPartes[1];
            const nombreMes = fechaPartes[3].charAt(0).toUpperCase() + fechaPartes[3].slice(1);

            // Actualizar texto en la interfaz
            document.getElementById('fecha-seleccionada').innerHTML = `${diaSemana}<br>${diaMes} ${nombreMes}`;
          }
        });
        calendar.render();
      }
      
      // Configurar envío del formulario
      function configurarFormulario() {
        const token = localStorage.getItem("jwt")

        document.getElementById('form-cita').addEventListener('submit', async function(event) {
          event.preventDefault();
          event.stopPropagation();

          if (!this.checkValidity()) {
            this.classList.add('was-validated');
            return;
          }
          
          // Recopilar datos del formulario
          const citaData = JSON.parse(sessionStorage.getItem('citaData')) || {};
          horaSeleccionada = document.getElementById('hora-cita').value;
          
          // Verificar que se haya seleccionado una fecha
          if (!fechaSeleccionada) {
            mostrarError("Por favor, selecciona una fecha en el calendario");
            return;
          }
          
          // Crear fecha y hora combinadas
          const fechaHora = `${fechaSeleccionada}T${horaSeleccionada}:00.000Z`;

          // Crear objeto de cita para enviar
          const nuevaCita = {
            ClienteId: user_id,
            TallerId: parseInt(citaData.tallerId || 1),
            ServicioId: parseInt(citaData.servicioId || 1),
            VehiculoId: parseInt(citaData.vehiculoId || 1),
            FechaHora: fechaHora,
            Estado: "Pendiente",
            RecepcionistaId: citaData.AdministradorID
          };
          
          console.log("Enviando datos de cita:", nuevaCita);

          try {
            const response = await fetch(`https://localhost:7190/api/Citas/AgregarNuevaCita`, {
              method: "POST",
              headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + token
              },
              body: JSON.stringify(nuevaCita)
            });

            const data = await response.json();

            if (!response.ok) {
              throw new Error(data.message || 'Error desconocido al agendar la cita.');
            }

            Swal.fire({
              title: 'Cita agendada',
              text: 'Tu cita ha sido agendada correctamente',
              icon: 'success',
              confirmButtonText: 'Ver mis citas'
            }).then((result) => {
              if (result.isConfirmed) {
                window.location.href = 'MiCitas.html';
              }
            });

          } catch (error) {
            console.error("Error al agendar cita:", error);
            Swal.fire({
              title: 'Error',
              text: error.message || 'No se pudo agendar la cita. Intenta nuevamente.',
              icon: 'error',
              confirmButtonText: 'Aceptar'
            });
          }
        });
      }
      
      // Función para mostrar errores
      function mostrarError(mensaje) {
        Swal.fire({
          title: 'Error',
          text: mensaje,
          icon: 'error',
          confirmButtonText: 'Entendido'
        });
      }
    </script>
  </body>
</html>