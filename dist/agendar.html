<!doctype html>
<html lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Agendar</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="title" content="AdminLTE v4 | Dashboard" />
    <meta name="author" content="ColorlibHQ" />
    <meta name="description" content="AdminLTE is a Free Bootstrap 5 Admin Dashboard, 30 example pages using Vanilla JS." />
    <meta name="keywords" content="bootstrap 5, bootstrap, bootstrap 5 admin dashboard, bootstrap 5 dashboard, bootstrap 5 charts, bootstrap 5 calendar, bootstrap 5 datepicker, bootstrap 5 tables, bootstrap 5 datatable, vanilla js datatable, colorlibhq, colorlibhq dashboard, colorlibhq admin dashboard" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fontsource/source-sans-3@5.0.12/index.css" integrity="sha256-tXJfXfp6Ewt1ilPzLDtQnJV4hclT9XuaZUKyUvmyr+Q=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/overlayscrollbars@2.10.1/styles/overlayscrollbars.min.css" integrity="sha256-tZHrRjVqNSRyWg2wbppGnT833E/Ys0DHWGwT04GiqQg=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" integrity="sha256-9kPW/n5nn53j4WMRYAxe9c1rCY96Oogo/MKSVdKzPmI=" crossorigin="anonymous" />
    <link rel="stylesheet" href="css/estilos.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/apexcharts@3.37.1/dist/apexcharts.css" integrity="sha256-4MX+61mt9NVvvuPjUWdUdyfZfxSB1/Rf9WtqRHgG5S0=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jsvectormap@1.5.3/dist/css/jsvectormap.min.css" integrity="sha256-+uGLJmmTKOqBr+2E6KDYs/NRsHxSkONXFHUL0fy2O/4=" crossorigin="anonymous" />
    <style>
      .map-container {
        margin-top: 20px;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      
      #map {
        height: 400px;
        width: 100%;
      }
      
      .gm-style-iw {
        padding: 10px;
        font-family: 'Source Sans 3', sans-serif;
      }
      
      .gm-style-iw h3 {
        margin-top: 0;
        margin-bottom: 5px;
        font-size: 16px;
      }
    </style>
  </head>
  <body class="layout-fixed sidebar-expand-lg bg-body-tertiary">
    <div class="app-wrapper">
      <nav class="app-header navbar navbar-expand bg-body">
        <div class="container-fluid">
          <ul class="navbar-nav ms-auto">
               
            <li class="nav-item dropdown user-menu">
                        <a href="#" class="nav-link dropdown-toggle"
                            data-bs-toggle="dropdown">
                            <img src="img/user2-160x160.jpg" class="user-image rounded-circle shadow" alt="User Image" />
                            <span class="d-none d-md-inline nombre-usuario">Fulanito Detal</span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-lg dropdown-menu-end">
                            <li class="user-header text-bg-primary">
                                <img src="img/user2-160x160.jpg" class="rounded-circle shadow" alt="User Image" />
                                <p class="nombre-usuario"> Fulanito Detal</p><small class="rol-usuario">Usuario</small>
                            </li>

                            <li class="user-footer"><a href="index.html"
                                    class="btn btn-default btn-flat float-end">Salir</a></li>
                        </ul>
                    </li>
          </ul>
        </div>
      </nav>
      <aside class="app-sidebar bg-body-secondary shadow" data-bs-theme="dark">
        <div class="sidebar-brand"><a href="./index.html" class="brand-link"><img src="img/fixtimeLogo.svg" alt="AdminLTE Logo" class="brand-image" /><span class="brand-text fw-light"></span></a></div>
        <div class="sidebar-wrapper">
          <nav class="mt-2" id="nav">
      
          </nav>
        </div>
      </aside>
      <main class="app-main">
        <div class="app-content-header">
          <div class="container">
            <div class="row">
              <div class="col-sm-6">
                <h3 class="mb-0">Agendar</h3>
              </div>
            </div>
          </div>
        </div>
        <div class="app-content">
          <div class="container">
            <div class="progress mb-2" role="progressbar" aria-label="succes striped example" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100">
              <div class="progress-bar progress-bar-striped progress-bar-animated bg-success" style="width: 30%; border-radius: 0.375rem"></div>
            </div>
            <div class="space"></div>
            <section class="agendamiento">
              <div class="card card-info mb-4">
                <form class="needs-validation" novalidate>
                  <div class="card-body">
                    <div class="card-body">
                      <div class="row g-3">
                        <!-- Selector de Talleres -->
                        <div class="col-md-4">
                          <label for="selectTaller" class="form-label">Seleccione su taller</label>
                          <select class="form-select" id="selectTaller" required>
                            <option selected disabled value="">Cargando talleres...</option>
                          </select>
                          <div class="invalid-feedback">Por favor selecciona un taller</div>
                        </div>
                        
                        <!-- Selector de Servicios -->
                        <div class="col-md-4">
                          <label for="selectServicio" class="form-label">Seleccione su servicio</label>
                          <select class="form-select" id="selectServicio" required>
                            <option selected disabled value="">Primero seleccione un taller</option>
                          </select>
                          <div class="invalid-feedback">Por favor selecciona un servicio</div>
                        </div>
                        
                        <!-- Selector de Vehículos -->
                        <div class="col-md-4">
                          <label for="selectVehiculo" class="form-label">Seleccione su vehículo</label>
                          <select class="form-select" id="selectVehiculo" required>
                            <option selected disabled value="">Cargando vehículos...</option>
                          </select>
                          <div class="invalid-feedback">Por favor selecciona un vehículo</div>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="card-footer"><button id="btn-paso2" class="btn btn-info" type="submit">Siguiente</button></div>
                </form>
              </div>
              
              <!-- Contenedor del mapa -->
              <div class="map-container">
                <div id="map"></div>
              </div>
            </section>
          </div>
        </div>
      </main>
      <footer class="app-footer">
        <div class="float-end d-none d-sm-inline">fixtime</div>
      </footer>
    </div>
    
    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/overlayscrollbars@2.10.1/browser/overlayscrollbars.browser.es6.min.js" integrity="sha256-dghWARbRe2eLlIJ56wNB+b760ywulqK3DzZYEpsg2fQ=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js" integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy" crossorigin="anonymous"></script>
    <script src="js/adminlte.js"></script>
    <script src="js/tokenservice.js"></script>
    
    <!-- API de Google Maps (reemplaza TU_API_KEY con tu clave real) -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD88arBYGxam0ov-DxtNx_LnJ_mH-9yqDo&callback=initMap" async defer></script>
    
    <script>
      // Variables globales
      const selectTaller = document.getElementById('selectTaller');
      const selectServicio = document.getElementById('selectServicio');
      const selectVehiculo = document.getElementById('selectVehiculo');
      const token = localStorage.getItem("jwt");
      const decode = parseJwt(token);
      const user_id = decode.UsuarioID;
      
      // Variables para el mapa
      let map;
      let markers = [];
      
      // Función para inicializar el mapa
      function initMap() {
        // Coordenadas iniciales (Bogotá como ejemplo)
        const medellin = { lat: 6.2442, lng: -75.5812 };
        
        // Crear el mapa
        map = new google.maps.Map(document.getElementById("map"), {
          zoom: 12,
          center: medellin,
          mapTypeId: 'roadmap'
        });
        
        // Cargar talleres en el mapa
        cargarTalleresEnMapa();
      }
      
      // Función para agregar talleres al mapa
      async function cargarTalleresEnMapa() {
        try {
          // Limpiar marcadores existentes
          clearMarkers();
          
          const talleres = await GetAllGarage();
          
          if (!talleres || talleres.length === 0) {
            console.log("No hay talleres para mostrar");
            return;
          }
          
          // Crear un marcador para cada taller
          talleres.forEach(taller => {
            // Verificar que el taller tenga coordenadas válidas
            if (taller.latitud && taller.longitud) {
              const position = {
                lat: taller.latitud,
                lng: taller.longitud
              };
              
              const marker = new google.maps.Marker({
                position: position,
                map: map,
                title: taller.nombre || "Taller sin nombre"
              });
              
              const infoWindow = new google.maps.InfoWindow({
                content: `<img src="img/store.svg" width="40px" alt=""><br> <div><strong>${taller.nombre || "Taller"}</strong><br>
                         ${taller.ubicacion || "Dirección no disponible"}</div>`
              });
              
              marker.addListener("click", () => {
                infoWindow.open(map, marker);
              });
              
              markers.push(marker);
            }
          });
          
          // Ajustar el zoom para que todos los marcadores sean visibles
          if (markers.length > 0) {
            const bounds = new google.maps.LatLngBounds();
            markers.forEach(marker => bounds.extend(marker.getPosition()));
            map.fitBounds(bounds);
            
            // Si solo hay un marcador, establecer un zoom adecuado
            if (markers.length === 1) {
              map.setZoom(15);
            }
          }
          
        } catch (error) {
          console.error("Error al cargar talleres en el mapa:", error);
        }
      }
      
      // Función para limpiar marcadores
      function clearMarkers() {
        markers.forEach(marker => marker.setMap(null));
        markers = [];
      }
      
      // Funciones para obtener datos de la API
      async function GetAllGarage() {
        try {
          const response = await fetch("http://localhost:5280/api/Taller/ObtenerTalleres", {
            method: "GET",
            headers: {
              'Content-Type': 'application/json',
              'Authorization': 'Bearer ' + token
            }
          });
      
          if (!response.ok) {
            alert("Ha ocurrido un error: " + response.status);
            return [];
          }
      
          return await response.json();
        } catch(error) {
          console.log("Ha ocurrido un error:", error);
          return [];
        }
      }
      
      async function GetServicesByTallerId(tallerid) {
        try {
          if (!tallerid || isNaN(tallerid)) {
            throw new Error("ID de taller inválido");
          }
      
          const url = `http://localhost:5280/api/Servicio/ObtenerServiciosPorTallerID/${tallerid}`;
          const response = await fetch(url, {
            method: "GET",
            headers: {
              "Content-Type": "application/json",
              "Authorization": "Bearer " + token
            }
          });
      
          if (!response.ok) {
            throw new Error(`Error HTTP: ${response.status}`);
          }
      
          return await response.json();
        } catch(error) {
          console.error("Error al obtener servicios:", error);
          throw error;
        }
      }
      
      async function GetVehiculeByUserId() {
        try {
          const response = await fetch(`http://localhost:5280/api/Vehiculo/ObtenerVehiculoPorClienteID/${user_id}`, {
            method: "GET",
            headers: {
              "Content-Type": "application/json",
              "Authorization": "Bearer " + token
            }
          });
      
          if (!response.ok) {
            alert("No se ha logrado obtener los vehículos");
            return [];
          }
      
          return await response.json();
        } catch(error) {
          console.log("Error al traer los datos:", error);
          return [];
        }
      }
      
      // Función para cargar talleres en el select
      async function cargarTalleres() {
        try {
          const talleres = await GetAllGarage();
          console.log("Datos de talleres recibidos:", talleres);
          
          selectTaller.innerHTML = '';
          const optionDefault = document.createElement('option');
          optionDefault.value = '';
          optionDefault.textContent = 'Seleccione un taller...';
          optionDefault.selected = true;
          optionDefault.disabled = true;
          selectTaller.appendChild(optionDefault);
          
          talleres.forEach(taller => {
            const option = document.createElement('option');
            option.value = taller.TallerId || taller.tallerId || taller.id || taller.ID || taller.tallerID;
            option.textContent = taller.nombre || taller.Nombre || "Taller sin nombre";
            selectTaller.appendChild(option);
          });
          
          // Actualizar el mapa con los talleres
          if (typeof google !== 'undefined' && google.maps) {
            cargarTalleresEnMapa();
          }
          
        } catch (error) {
          console.error("Error cargando talleres:", error);
          selectTaller.innerHTML = '<option value="">Error cargando talleres</option>';
        }
      }
      
      // Función para cargar servicios por taller
      async function cargarServiciosPorTaller(tallerId) {
        try {
          if (!tallerId || isNaN(tallerId)) {
            console.error("ID de taller inválido:", tallerId);
            selectServicio.innerHTML = '<option value="">ID de taller inválido</option>';
            return;
          }
      
          selectServicio.disabled = true;
          selectServicio.innerHTML = '<option selected disabled value="">Cargando servicios...</option>';
          
          const servicios = await GetServicesByTallerId(tallerId);
          console.log("Respuesta de servicios:", servicios);
          
          selectServicio.innerHTML = '';
          const optionDefault = document.createElement('option');
          optionDefault.value = '';
          optionDefault.textContent = 'Seleccione un servicio...';
          optionDefault.selected = true;
          optionDefault.disabled = true;
          selectServicio.appendChild(optionDefault);
          
          if (servicios && Array.isArray(servicios) && servicios.length > 0) {
            servicios.forEach(servicio => {
              const option = document.createElement('option');
              option.value = servicio.servicioID || servicio.servicioId;
              option.textContent = servicio.Nombre || servicio.nombre;
              selectServicio.appendChild(option);
            });
          } else {
            selectServicio.innerHTML = '<option value="">No hay servicios disponibles</option>';
          }
          
          selectServicio.disabled = false;
          
        } catch (error) {
          console.error("Error cargando servicios:", error);
          selectServicio.innerHTML = '<option value="">Error cargando servicios</option>';
        }
      }
      
      // Función para cargar vehículos del usuario
      async function cargarVehiculos() {
        try {
          const vehiculos = await GetVehiculeByUserId();
          
          selectVehiculo.innerHTML = '';
          const optionDefault = document.createElement('option');
          optionDefault.value = '';
          optionDefault.textContent = 'Seleccione un vehículo...';
          optionDefault.selected = true;
          optionDefault.disabled = true;
          selectVehiculo.appendChild(optionDefault);
          
          vehiculos.forEach(vehiculo => {
            const option = document.createElement('option');
            option.value = vehiculo.vehiculoID;
            option.textContent = `${vehiculo.marca} ${vehiculo.modelo}`;
            selectVehiculo.appendChild(option);
          });
          
        } catch (error) {
          console.error("Error cargando vehículos:", error);
          selectVehiculo.innerHTML = '<option value="">Error cargando vehículos</option>';
        }
      }
      
      // Evento cuando cambia el selector de talleres
      selectTaller.addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        
        if (selectedOption.value && !isNaN(selectedOption.value)) {
          cargarServiciosPorTaller(parseInt(selectedOption.value));
          
          // Resaltar el taller seleccionado en el mapa
          if (markers.length > 0) {
            const selectedTallerId = parseInt(selectedOption.value);
            markers.forEach(marker => {
              // Asumimos que el marker tiene una propiedad tallerId
              if (marker.tallerId === selectedTallerId) {
                // Animación para resaltar el marcador
                marker.setAnimation(google.maps.Animation.BOUNCE);
                setTimeout(() => {
                  marker.setAnimation(null);
                }, 1500);
                
                // Centrar el mapa en el marcador
                map.panTo(marker.getPosition());
                map.setZoom(15);
              }
            });
          }
        } else {
          selectServicio.innerHTML = '<option selected disabled value="">Seleccione un taller válido</option>';
          selectServicio.disabled = true;
        }
      });
      
      // Validación del formulario
      (() => {
        'use strict';
        const forms = document.querySelectorAll('.needs-validation');
        
        Array.from(forms).forEach((form) => {
          form.addEventListener('submit', (event) => {
            if (!form.checkValidity()) {
              event.preventDefault();
              event.stopPropagation();
            }
            form.classList.add('was-validated');
          }, false);
        });
      })();
      
      // Evento para el botón de siguiente paso
      document.getElementById("btn-paso2").addEventListener("click", function(e) {
        e.preventDefault();
        
        const form = document.querySelector('.needs-validation');
        if (!form.checkValidity()) {
          e.stopPropagation();
          form.classList.add('was-validated');
          return;
        }
      
        // Guardar selección para la siguiente página
        const citaData = {
          tallerId: selectTaller.value,
          servicioId: selectServicio.value,
          vehiculoId: selectVehiculo.value
        };
        sessionStorage.setItem('citaData', JSON.stringify(citaData));
        
        window.location.href = "agendar2.html";
      });
      
      // Cargar datos al iniciar la página
      document.addEventListener('DOMContentLoaded', async () => {
        await cargarTalleres();
        await cargarVehiculos();
      });
    </script>
  </body>
</html>